build:
  docker:
    web: Dockerfile
  config:
    # Spécifiez les variables d'environnement pour l'application
    DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
    DEBUG: 0

release:
  image: bubhux/bubhux-oc-image-build:latest
  command:
    - /bin/sh
    - -c
    - |
      # Commandes ou scripts de déploiement supplémentaires si nécessaire
      HEROKU_DEBUG=1 heroku container:release web

env:
  HEROKU_API_KEY: ${HEROKU_API_KEY}
  HEROKU_APP_NAME: ${HEROKU_APP_NAME}
  HEROKU_EMAIL: ${HEROKU_EMAIL}

deploy_to_heroku:
    needs: build_and_push_to_dockerhub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Purge Heroku cache
        run: |
          heroku plugins:install heroku-repo
          heroku repo:purge_cache -a ${{ secrets.HEROKU_APP_NAME }}

      - name: Log in to Heroku Container Registry
        run: heroku container:login
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Push to Heroku Container Registry
        run: heroku container:push -a ${{ secrets.HEROKU_APP_NAME }} web

      - name: Deploy to Heroku
        run: |
          HEROKU_API_KEY=${{ secrets.HEROKU_API_KEY }} \
          HEROKU_APP_NAME=${{ secrets.HEROKU_APP_NAME }} \
          HEROKU_EMAIL=${{ secrets.HEROKU_EMAIL }} \
          HEROKU_DEBUG=1 heroku container:release -a ${{ secrets.HEROKU_APP_NAME }} web

